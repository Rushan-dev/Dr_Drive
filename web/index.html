<!DOCTYPE html>
<html>
<head>
  <base href="/">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Google Identity Services -->
  <meta name="google-signin-client_id" content="1067293077128-676gsgj2558pg8094iklij773gg0rkm7.apps.googleusercontent.com">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <meta name="google-signin-scope" content="profile email">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="smart_traffic_app">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="icon" type="image/png" href="favicon.png"/>
  <title>smart_traffic_app</title>
  <link rel="manifest" href="manifest.json">

  <!-- Flutter Web Configuration -->
  <script>
    // Flutter web configuration
    window.flutterConfiguration = {
      // Add any Flutter configuration here
    };
    
    // The value below is injected by flutter build, do not touch.
    const serviceWorkerVersion = '0.0.1';
    
    // This is the service worker script that is used to cache the application.
    // This variable is set by flutter build.
    const serviceWorkerUrl = 'flutter_service_worker.js';
    
    // The Flutter loader configuration
    window._flutter = window._flutter || {};
    window._flutter.loader = {
      loadEntrypoint: function(entrypoint) {
        return Promise.resolve().then(function() {
          return new Promise(function(resolve, reject) {
            const script = document.createElement('script');
            script.src = 'main.dart.js';
            script.type = 'application/javascript';
            script.defer = true;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
          });
        });
      }
    };
  </script>

  <!-- Firebase SDKs -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup,
      signOut as firebaseSignOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      doc, 
      setDoc, 
      getDoc, 
      updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA44JzCfzZ96CAczd5pWZSVM0pcUn4c_uY",
      authDomain: "dr-drive-e1ceb.firebaseapp.com",
      projectId: "dr-drive-e1ceb",
      storageBucket: "dr-drive-e1ceb.firebasestorage.app",
      messagingSenderId: "902970483982",
      appId: "1:902970483982:web:c48494b745b2d6852f635f",
      measurementId: "G-5XDHRJ6K2N"
    };

    // Initialize Firebase
    let auth, db, storage, googleProvider;

    try {
      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
      googleProvider = new GoogleAuthProvider();

      // Add scopes
      googleProvider.addScope('profile');
      googleProvider.addScope('email');

      // Initialize Analytics
      const analytics = getAnalytics(app);

      // Make them available globally for Flutter web
      window.firebaseApp = app;
      window.firebaseAuth = auth;
      window.firebaseDb = db;
      window.firebaseStorage = storage;
      window.googleAuthProvider = googleProvider;
      window.firebaseSignOut = firebaseSignOut;
      window.firebaseCollection = collection;
      window.firebaseDoc = doc;
      window.firebaseSetDoc = setDoc;
      window.firebaseGetDoc = getDoc;
      window.firebaseUpdateDoc = updateDoc;
      
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization error:', error);
    }
    
    // Google Sign-In function
    window.signInWithGoogle = async () => {
      if (!auth) {
        console.error('Firebase Auth not initialized');
        return null;
      }
      try {
        const result = await signInWithPopup(auth, googleProvider);
        return result.user;
      } catch (error) {
        console.error("Error during Google Sign In:", error);
        throw error;
      }
    };
  </script>
  
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6TCAfxe_u-VrPCAAlmIEjGCfwjYtRj9Y&libraries=places&loading=async" defer></script>
  
  <!-- Flutter Web Engine -->
  <script src="flutter.js" defer></script>
  
  <script>
    // Initialize the Flutter app when the window loads
    window.addEventListener('load', function() {
      console.log('Window loaded, initializing Flutter...');
      
      // Check if Flutter loader is available
      if (typeof _flutter === 'undefined') {
        console.error('Flutter JavaScript not loaded. Check console for errors.');
        return;
      }
      
      if (!_flutter.loader) {
        console.error('Flutter loader not found. Make sure flutter.js is loaded correctly.');
        return;
      }

      console.log('Loading Flutter application...');
      _flutter.loader.loadEntrypoint({
        onEntrypointLoaded: async function(engineInitializer) {
          try {
            console.log('Flutter entrypoint loaded, initializing engine...');
            const appRunner = await engineInitializer.initializeEngine();
            console.log('Flutter engine initialized, running app...');
            await appRunner.runApp();
            console.log('Flutter app running');
          } catch (error) {
            console.error('Failed to start Flutter app:', error);
          }
        }
      });
    });
  </script>
</head>
<body>
  <div id="loading">Loading Flutter application...</div>
  <script>
    // Hide loading message when Flutter is ready
    window.addEventListener('flutter-first-frame', function() {
      const loading = document.getElementById('loading');
      if (loading) loading.style.display = 'none';
    });
  </script>
  <!-- The flutter web app will be rendered here -->
  <script>
    window.flutterWebRenderer = "html";  // Force HTML renderer
  </script>
</body>
</html>